<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Broadband‑News Dashboard</title>

    <!-- date helper -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>
      dayjs.extend(window.dayjs_plugin_relativeTime);
    </script>

    <style>
      :root {
        --bg: #f7f9fc;
        --card: #ffffff;
        --accent: #0057b7;
        --accent-light: #e9f1ff;
        --border: #d7e0ea;
        --text-light: #666;
        --text-dark: #111;
        --warn: #f9a825;
        --error: #d32f2f;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font: 400 16px/1.4 system-ui, sans-serif;
      }
      body {
        background: var(--bg);
        padding: 2rem;
        display: flex;
        justify-content: center;
      }
      main {
        width: 100%;
        max-width: 1000px;
      }
      h1 {
        font-size: 1.9rem;
        margin-bottom: 0.8rem;
        color: var(--text-dark);
      }
      h1 small {
        font-size: 1rem;
        color: var(--text-light);
      }

      #controls {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        line-height: 1.2;
      }
      button:disabled {
        opacity: 0.55;
        cursor: progress;
      }
      button:hover:not(:disabled) {
        filter: brightness(1.08);
      }
      #status {
        font-size: 0.95rem;
        color: #444;
        margin-left: auto;
      }

      #searchWrapper {
        position: relative;
        display: flex;
        align-items: center;
        flex-grow: 1;
        max-width: 400px;
      }
      #searchInput {
        width: 100%;
        padding: 0.6rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: 0.2s;
      }
      #searchInput:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-light);
      }
      #clearSearch {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: #777;
        cursor: pointer;
        padding: 0;
        font-size: 1.2rem;
        display: none;
      }
      #clearSearch:hover {
        color: #333;
      }

      #apiKeySettings {
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: var(--accent-light);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      #apiKeySettings label {
        font-weight: 500;
      }
      #apiKeyInput {
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        flex-grow: 1;
        min-width: 200px;
      }
      #apiKeyInput:focus {
        outline: none;
        border-color: var(--accent);
      }
      #apiKeySettings button {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
        background-color: #4caf50;
      }
      #apiKeyStatus {
        color: var(--text-light);
        font-style: italic;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        background: var(--card);
      }
      thead {
        background: var(--accent-light);
      }
      th,
      td {
        padding: 0.75rem 0.9rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      th {
        font-weight: 600;
        cursor: pointer;
        user-select: none;
      }
      tr:hover td {
        background: #fafcff;
      }
      tr.hidden {
        display: none;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .overview-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        background-color: #555;
        white-space: nowrap;
      }
      .overview-btn:disabled {
        background-color: #999;
        filter: none;
      }

      #noResults {
        text-align: center;
        padding: 2rem;
        color: var(--text-light);
        background: var(--card);
        border-radius: 12px;
        display: none;
      }

      th:nth-child(1),
      td:nth-child(1) {
        width: 100px;
      } /* Date */
      th:nth-child(2),
      td:nth-child(2) {
        width: 110px;
      } /* Source */
      th:nth-child(3),
      td:nth-child(3) {
      }
      th:nth-child(4),
      td:nth-child(4) {
        width: 150px;
      }

      /* Modal Styles */
      .modal {
        display: none; /* Hidden by default, JS will toggle */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Should not be needed if modal-content handles scroll */
        background-color: rgba(0, 0, 0, 0.6);
        /* Flexbox for centering */
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex; /* Use flex to show and center */
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto; /* Fallback if flex not fully supported or for older interpretation */
        padding: 25px;
        border: 1px solid #888;
        width: 80%;
        max-width: 700px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
        max-height: 85vh; /* Limit height */
        display: flex; /* For internal layout */
        flex-direction: column;
      }
      #modalArticleTitle {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--text-dark);
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.75rem;
        flex-shrink: 0; /* Prevent title from shrinking */
      }
      #modalSummaryContent {
        overflow-y: auto; /* Allow summary to scroll */
        line-height: 1.6;
        margin-top: 10px; /* Space between title and summary */
        flex-grow: 1; /* Allow this area to take up available space */
        min-height: 50px; /* Ensure some space even if empty initially */
      }
      .modal-close-btn {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        line-height: 1;
      }
      .modal-close-btn:hover,
      .modal-close-btn:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .loading-summary,
      .error-summary {
        font-style: italic;
        color: var(--text-light);
        padding: 10px 0;
      }
      .error-summary {
        color: var(--error);
        font-weight: bold;
      }

      @media (max-width: 768px) {
        th:nth-child(4),
        td:nth-child(4) {
          width: 120px;
        }
        th:nth-child(1),
        td:nth-child(1) {
          width: 90px;
        }
        th:nth-child(2),
        td:nth-child(2) {
          width: 110px;
        }
        .modal-content {
          width: 90%;
          padding: 20px;
        }
        #modalArticleTitle {
          font-size: 1.3rem;
        }
      }
      @media (max-width: 600px) {
        #controls {
          flex-direction: column;
          align-items: stretch;
        }
        #searchWrapper {
          max-width: 100%;
          margin-bottom: 0.5rem;
        }
        #status {
          margin-left: 0;
          text-align: center;
          margin-top: 0.5rem;
        }
        #apiKeySettings {
          flex-direction: column;
          align-items: stretch;
        }
        #apiKeyInput {
          min-width: unset;
        }
        th,
        td {
          padding: 0.5rem;
          font-size: 0.9rem;
        }
        th:nth-child(3),
        td:nth-child(3) {
          padding-right: 0.5rem;
        }
        th:nth-child(4),
        td:nth-child(4) {
          padding-left: 0.5rem;
          width: 100px;
        }
        .modal-content {
          width: 95%;
          padding: 15px;
          max-height: 90vh;
        }
        #modalArticleTitle {
          font-size: 1.1rem;
          margin-bottom: 0.75rem;
          padding-bottom: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Broadband‑Related Headlines <small> (last 90 days)</small></h1>

      <div id="controls">
        <button id="fetchBtn">Fetch latest news</button>
        <div id="searchWrapper">
          <input
            type="text"
            id="searchInput"
            placeholder="Search articles..."
            aria-label="Search articles"
          />
          <button id="clearSearch" aria-label="Clear search">×</button>
        </div>
        <span id="status"></span>
      </div>

      <div id="apiKeySettings">
        <label for="apiKeyInput">OpenAI API Key:</label>
        <input
          type="password"
          id="apiKeyInput"
          placeholder="Paste your OpenAI API Key (stored locally)"
        />
        <button id="saveApiKeyBtn">Save Key</button>
        <span id="apiKeyStatus"></span>
      </div>

      <div id="noResults">No matching articles found</div>

      <table id="news" hidden>
        <thead>
          <tr>
            <th data-key="article_date">Date ▼</th>
            <th data-key="source">Source</th>
            <th data-key="article_title">Title</th>
            <th>AI Overview</th>
          </tr>
        </thead>
        <tbody>
          <!-- Content added by JS -->
        </tbody>
      </table>
    </main>

    <!-- AI Summary Modal -->
    <div id="aiSummaryModal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn" aria-label="Close modal">×</span>
        <h2 id="modalArticleTitle">Article Title</h2>
        <div id="modalSummaryContent">
          <!-- Summary, loading, or error message will be injected here by JS -->
          <p class="loading-summary">Loading summary...</p>
        </div>
        <div id="modalErrorContent" class="error-summary" style="display: none">
          <!-- Error specific messages can go here -->
        </div>
      </div>
    </div>

    <script>
      /* ───────── CONFIG ───────── */
      const CORS_PROXY = "https://api.allorigins.win/raw?url=";
      const N_ARTICLES = 10;
      const CUTOFF = dayjs().subtract(90, "day").toDate();
      const OPENAI_API_KEY_STORAGE = "openaiApiKey";
      const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
      const OPENAI_MODEL = "gpt-3.5-turbo";

      /* ───────── DOM ELEMENTS ───────── */
      const $ = (sel, root = document) => root.querySelector(sel);
      const $all = (sel, root = document) => [...root.querySelectorAll(sel)];
      const modal = $("#aiSummaryModal");
      const modalTitleEl = $("#modalArticleTitle");
      const modalSummaryEl = $("#modalSummaryContent");
      const modalErrorEl = $("#modalErrorContent"); // For distinct error messages if needed
      const modalCloseBtn = $(".modal-close-btn", modal);

      /* ───────── HELPERS ───────── */
      function parseHTML(html) {
        return new DOMParser().parseFromString(html, "text/html");
      }
      async function fetchDoc(url, options = {}) {
        try {
          const response = await fetch(
            CORS_PROXY + encodeURIComponent(url),
            options
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const text = await response.text();
          if (
            text.includes("allorigins error") ||
            text.includes("target server error")
          ) {
            console.warn(
              `CORS Proxy error for ${url}: ${text.substring(0, 100)}...`
            );
            throw new Error("CORS Proxy error fetching content.");
          }
          return parseHTML(text);
        } catch (error) {
          console.error(`Error fetching document ${url}:`, error);
          throw error;
        }
      }
      function keepDate(d) {
        return d && d >= CUTOFF;
      }
      function tryParse(raw, ...fmts) {
        raw = (raw || "").trim();
        for (const f of fmts) {
          const d = dayjs(raw, f, true);
          if (d.isValid()) return d.toDate();
        }
        return null;
      }

      /* ───────── API Key Management ───────── */
      function getApiKey() {
        let key = localStorage.getItem(OPENAI_API_KEY_STORAGE);
        if (!key) {
          key = prompt(
            "Please enter your OpenAI API Key for summarization.\nIt will be stored locally in your browser."
          );
          if (key) {
            saveApiKey(key);
          } else {
            return null;
          }
        }
        return key;
      }

      function saveApiKey(key) {
        if (key && typeof key === "string" && key.trim()) {
          localStorage.setItem(OPENAI_API_KEY_STORAGE, key.trim());
          updateApiKeyStatus(true);
          $("#apiKeyInput").value = key.trim();
          return true;
        }
        updateApiKeyStatus(false);
        return false;
      }

      function updateApiKeyStatus(isSet) {
        const statusEl = $("#apiKeyStatus");
        if (isSet) {
          statusEl.textContent = "OpenAI Key saved locally.";
          statusEl.style.color = "green";
        } else {
          const currentKey = localStorage.getItem(OPENAI_API_KEY_STORAGE);
          statusEl.textContent = currentKey
            ? "OpenAI Key saved locally."
            : "OpenAI Key not set.";
          statusEl.style.color = currentKey ? "green" : "var(--text-light)";
        }
      }

      /* ───────── 12 SCRAPERS (Unchanged) ───────── */
      async function scrape_ntia() {
        const doc = await fetchDoc(
          "https://broadbandusa.ntia.gov/news/latest-news"
        );

        return $all("div.views-row", doc)
          .slice(0, N_ARTICLES)
          .map((row) => {
            // Get the anchor tag within the field-content span
            const linkElement = $("span.field-content a", row);
            const dateElement = $(
              "div.views-field-created span.field-content",
              row
            );

            // Skip if essential elements are missing
            if (!linkElement || !dateElement) return null;

            // Parse the date
            const d = tryParse(dateElement.textContent, "MMMM D, YYYY");
            if (!keepDate(d)) return null;

            // Get the href attribute directly - this is the relative URL
            const relativeUrl = linkElement.getAttribute("href");

            // Construct the proper full URL for production
            const fullUrl = "https://broadbandusa.ntia.gov" + relativeUrl;

            return {
              source: "NTIA",
              article_title: linkElement.textContent.trim(),
              article_url: fullUrl,
              article_date: d,
            };
          })
          .filter(Boolean);
      }

      async function scrape_theverge() {
        const doc = await fetchDoc("https://www.theverge.com/");
        return $all("article", doc)
          .slice(0, N_ARTICLES)
          .map((c) => {
            const a = $("a[data-analytics-link]", c);
            const d = tryParse($("time", c)?.dateTime, "YYYY-MM-DD");
            if (!a || !keepDate(d)) return null;
            let link = a.href;
            if (!/^https?:/.test(link))
              link = "https://www.theverge.com" + link;
            return {
              source: "The Verge",
              article_title: a.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }

      async function scrape_telecompetitor() {
        const doc = await fetchDoc("https://www.telecompetitor.com/articles/");

        // Find all article blocks - they have li elements with classes containing "wp-block-post"
        const articleBlocks = doc.querySelectorAll(
          'li[class*="wp-block-post"]'
        );

        // If no article blocks found with that selector, try a broader approach
        const articles =
          articleBlocks.length > 0
            ? articleBlocks
            : doc.querySelectorAll('div[class*="wp-block-post"]');

        return Array.from(articles)
          .slice(0, N_ARTICLES)
          .map((article) => {
            // Find the article title and URL
            const titleLink =
              article.querySelector("h2 a") ||
              article.querySelector('a[href*="telecompetitor.com"]');

            const title = titleLink ? titleLink.textContent.trim() : null;
            const url = titleLink ? titleLink.href : null;

            // Find the date if available
            const timeElement = article.querySelector("time");
            const dateText = timeElement
              ? timeElement.textContent.trim()
              : null;
            const date = dateText ? tryParse(dateText, "MMMM D, YYYY") : null;

            if (!title || !url) return null;

            return {
              source: "Telecompetitor",
              article_title: title,
              article_url: url,
              article_date: date || new Date(), // Default to current date if not found
            };
          })
          .filter(Boolean);
      }

      // / Couldn't find relevant broadband article
      async function scrape_networkworld() {
        const doc = await fetchDoc("https://www.networkworld.com/news/");
        return $all("div.card", doc)
          .slice(0, N_ARTICLES)
          .map((c) => {
            const h3 = $("h3.card__title", c),
              a = $("a", c);
            const d = tryParse($("time", c)?.dateTime, "YYYY-MM-DD");
            if (!h3 || !a || !keepDate(d)) return null;
            let link = a.href;
            if (!/^https?:/.test(link))
              link = "https://www.networkworld.com" + link;
            return {
              source: "Network World",
              article_title: h3.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }
      async function scrape_lightreading() {
        // Using the search URL you provided
        const doc = await fetchDoc(
          "https://www.lightreading.com/search?q=BEAD&sort=newest"
        );

        // From the HTML, we can see search results are in elements with class "ListPreview"
        // inside "SearchResult-ContentPreview" containers
        const articles = doc.querySelectorAll(
          ".SearchResult-ContentPreview .ListPreview"
        );

        if (!articles || articles.length === 0) {
          // Fallback selectors if the primary selector doesn't find articles
          const fallbackArticles =
            doc.querySelectorAll(".ListPreview") ||
            doc.querySelectorAll('[class*="ArticlePreview"]');

          if (fallbackArticles && fallbackArticles.length > 0) {
            articles = fallbackArticles;
          }
        }

        return Array.from(articles)
          .slice(0, N_ARTICLES)
          .map((article) => {
            // From the HTML, we can see the title is in elements with class "ListPreview-Title"
            const titleElement = article.querySelector(".ListPreview-Title");

            if (!titleElement) return null;

            const title = titleElement.textContent.trim();

            // Get URL - in the HTML, it's the href attribute of the anchor containing the title
            let url = titleElement.getAttribute("href") || "";
            if (url.startsWith("/")) {
              url = "https://www.lightreading.com" + url;
            }

            // From the new HTML, we can see the date is in span.ListPreview-Date
            const dateElement = article.querySelector("span.ListPreview-Date");
            const dateText = dateElement
              ? dateElement.textContent.trim()
              : null;
            const date = dateText ? tryParse(dateText, "MMM D, YYYY") : null;

            if (!title || !url || !keepDate(date)) return null;

            return {
              source: "Light Reading",
              article_title: title,
              article_url: url,
              article_date: date,
            };
          })
          .filter(Boolean);
      }

      async function scrape_broadbandnow() {
        const doc = await fetchDoc("https://broadbandnow.com/research");
        return $all("div.card.research", doc)
          .slice(0, N_ARTICLES)
          .map((c) => {
            const a = $("h2.card-title", c),
              link = $("a.thumbnail", c);
            const d = tryParse(
              $("p.card-updated-date", c)?.textContent,
              "MMMM D, YYYY"
            );
            if (!a || !link || !keepDate(d)) return null;
            return {
              source: "BroadbandNow",
              article_title: a.textContent.trim(),
              article_url: link.href,
              article_date: d,
            };
          })
          .filter(Boolean);
      }
      async function scrape_rcrwireless() {
        const doc = await fetchDoc("https://www.rcrwireless.com/");
        return $all("div.td-module-thumb", doc)
          .slice(0, N_ARTICLES)
          .map((b) => {
            const par = b.parentElement;
            const title = $("h3.entry-title a", par);
            const d = tryParse(
              $("time.entry-date", par)?.dateTime,
              "YYYY-MM-DD"
            );
            if (!title || !keepDate(d)) return null;
            return {
              source: "RCR Wireless",
              article_title: title.textContent.trim(),
              article_url: title.href,
              article_date: d,
            };
          })
          .filter(Boolean);
      }
      async function scrape_lightwave() {
        const doc = await fetchDoc("https://www.lightwaveonline.com/broadband");
        return $all("a.title-wrapper", doc)
          .slice(0, N_ARTICLES)
          .map((a) => {
            const d = tryParse(
              a.closest("div")?.querySelector("div.date")?.textContent,
              "MMM D, YYYY"
            );
            let link = a.href;
            if (link.startsWith("/"))
              link = "https://www.lightwaveonline.com" + link;
            if (!keepDate(d)) return null;
            return {
              source: "Lightwave Online",
              article_title: a.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }
      async function scrape_advanced_tv() {
        const doc = await fetchDoc(
          "https://www.advanced-television.com/?s=broadband"
        );
        return $all("article.text-secondary", doc)
          .slice(0, N_ARTICLES)
          .map((art) => {
            const a = $("a.text-dark", art);
            const d = tryParse(
              $("div.border span", art)?.textContent,
              "MMMM D, YYYY"
            );
            let link = a?.href || "";
            if (link.startsWith("/"))
              link = "https://www.advanced-television.com" + link;
            if (!a || !keepDate(d)) return null;
            return {
              source: "Advanced TV",
              article_title: a.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }
      async function scrape_cnet() {
        const doc = await fetchDoc(
          "https://www.cnet.com/search/?searchQuery=broadband"
        );
        return $all("article.c-pageSearch_searchResult", doc)
          .slice(0, N_ARTICLES)
          .map((art) => {
            const a = $("a.c-pageSearch_searchResultUrlContainer", art);
            const d = tryParse($("time", art)?.dateTime, "YYYY-MM-DD");
            let link = a?.href || "";
            if (link.startsWith("/")) link = "https://www.cnet.com" + link;
            if (!a || !keepDate(d)) return null;
            return {
              source: "CNET",
              article_title: a.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }

      async function scrape_fiberoptics() {
        const doc = await fetchDoc(
          "https://www.fiberopticsonline.com/hub/bucket/homelatestheadlines"
        );

        return $all("li.mb-2.vm-summary-link", doc)
          .slice(0, N_ARTICLES)
          .map((li) => {
            const a = li.querySelector("a");
            const d = tryParse(
              li.querySelector("em.vm-hub-date")?.textContent,
              "MMM D, YYYY"
            );

            if (!a || !keepDate(d)) return null;

            // Get the article title
            const title = a.textContent.trim();

            // Extract the href attribute directly - this is the key fix
            const href = a.getAttribute("href");
            console.log("Original href:", href);

            // Simply prepend the domain to the href which already has the full path
            const fullUrl = href.startsWith("http")
              ? href
              : "https://www.fiberopticsonline.com" +
                (href.startsWith("/") ? href : "/" + href);

            console.log("Full URL:", fullUrl);

            return {
              source: "Fiber Optics Online",
              article_title: title,
              article_url: fullUrl,
              article_date: d,
            };
          })
          .filter(Boolean);
      }

      async function scrape_techradar() {
        const doc = await fetchDoc(
          "https://www.techradar.com/search?searchTerm=broadband"
        );
        return $all("article.search-result", doc)
          .slice(0, N_ARTICLES)
          .map((art) => {
            const h3 = $("h3.article-name", art),
              a = $("a.article-link", art);
            const d = tryParse(
              $("time.no-wrap.relative-date.date-with-prefix", art)?.dateTime,
              "YYYY-MM-DD"
            );
            let link = a?.href || "";
            if (link.startsWith("/")) link = "https://www.techradar.com" + link;
            if (!h3 || !keepDate(d)) return null;
            return {
              source: "TechRadar",
              article_title: h3.textContent.trim(),
              article_url: link,
              article_date: d,
            };
          })
          .filter(Boolean);
      }

      const SCRAPERS = [
        scrape_ntia,
        scrape_theverge,
        scrape_telecompetitor,
        scrape_networkworld,
        scrape_lightreading,
        scrape_broadbandnow,
        scrape_rcrwireless,
        scrape_lightwave,
        scrape_advanced_tv,
        scrape_cnet,
        scrape_fiberoptics,
        scrape_techradar,
      ];

      /* ───────── AI Summarization & Modal ───────── */
      function extractMainContent(doc, url = "") {
        // Add a default empty string for url to prevent undefined errors

        // Special handling for Light Reading
        if (url && url.includes("lightreading.com")) {
          const articleBody = doc.querySelector(
            ".article-body, .article-content, .article-text"
          );
          if (articleBody) {
            const paragraphs = articleBody.querySelectorAll("p");
            let text = Array.from(paragraphs)
              .map((p) => p.textContent.trim())
              .join("\n");
            text = text.replace(/\s{2,}/g, " ").trim();
            const MAX_LENGTH = 10000;
            if (text.length > MAX_LENGTH) {
              console.warn("Extracted text truncated for API call.");
              text = text.substring(0, MAX_LENGTH) + "...";
            }
            return text;
          }

          // Fallback for Light Reading if the specific selectors don't work
          const contentContainer = doc.querySelector(
            '.container, main, [role="main"], #main-content'
          );
          if (contentContainer) {
            // Exclude navigation, headers, footers, and sidebars
            const excludeSelectors =
              "nav, header, footer, aside, .sidebar, .comments, .related-articles, .advertisement";
            const excludeElements =
              contentContainer.querySelectorAll(excludeSelectors);
            excludeElements.forEach((el) => {
              if (el.parentNode) el.parentNode.removeChild(el);
            });

            const paragraphs = contentContainer.querySelectorAll("p");
            let text = Array.from(paragraphs)
              .map((p) => p.textContent.trim())
              .join("\n");
            text = text.replace(/\s{2,}/g, " ").trim();
            if (text.length > 10000) text = text.substring(0, 10000) + "...";
            return text;
          }
        }

        // Original selectors for other sites
        const selectors = [
          "article",
          "main",
          ".main-content",
          ".post-content",
          ".entry-content",
          ".article-body",
          ".story-content",
          'div[role="main"]',
        ];
        let mainEl = null;
        for (const selector of selectors) {
          mainEl = doc.querySelector(selector);
          if (mainEl) break;
        }
        if (!mainEl) mainEl = doc.body;
        const paragraphs = $all("p", mainEl);
        let text = paragraphs.map((p) => p.textContent.trim()).join("\n");
        text = text.replace(/\s{2,}/g, " ").trim();
        const MAX_LENGTH = 10000;
        if (text.length > MAX_LENGTH) {
          console.warn("Extracted text truncated for API call.");
          text = text.substring(0, MAX_LENGTH) + "...";
        }
        if (text.length < 100) console.warn("Extracted text seems very short.");
        return text;
      }

      async function fetchArticleText(url) {
        console.log(`Fetching article content for: ${url}`);
        const doc = await fetchDoc(url);
        const extractedText = extractMainContent(doc, url);
        console.log(extractedText);
        return extractedText;
      }

      async function getOpenAISummary(text, apiKey) {
        if (!text)
          throw new Error("No text content provided for summarization.");
        console.log(
          `Requesting summary from OpenAI for ${text.length} chars...`
        );
        const response = await fetch(OPENAI_API_URL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${apiKey}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            messages: [
              {
                role: "system",
                content:
                  "You are a helpful assistant. Summarize the provided news article text concisely, focusing on the key information. Aim for a summary of 2-4 bullet points. Clearly structure the response as bullet points.",
              },
              { role: "user", content: text },
            ],
            max_tokens: 150,
            temperature: 0.5,
          }),
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            error: { message: "Unknown API error or non-JSON response" },
          }));
          let errorMessage = `OpenAI API Error: ${response.status}`;
          if (errorData.error && errorData.error.message)
            errorMessage += ` - ${errorData.error.message}`;
          if (errorData.error && errorData.error.code === "insufficient_quota")
            errorMessage =
              "OpenAI API Error: Insufficient quota. Please check your OpenAI account balance/limits.";
          console.error("OpenAI API Error Response:", errorData);
          throw new Error(errorMessage);
        }
        const result = await response.json();
        console.log("OpenAI API Success:", result);
        if (
          result.choices &&
          result.choices.length > 0 &&
          result.choices[0].message &&
          result.choices[0].message.content
        ) {
          return result.choices[0].message.content.trim();
        } else {
          console.error("Unexpected OpenAI API response format:", result);
          throw new Error("Could not parse summary from OpenAI API response.");
        }
      }

      function openModal(articleTitle, summaryPromise) {
        modal.classList.add("active");
        modalTitleEl.textContent = articleTitle;
        modalSummaryEl.innerHTML =
          '<p class="loading-summary">Generating summary...</p>';
        modalSummaryEl.style.display = "block"; // Ensure summary area is visible
        modalErrorEl.textContent = ""; // Clear previous errors
        modalErrorEl.style.display = "none";

        summaryPromise
          .then((summary) => {
            modalSummaryEl.innerHTML = `<p>${summary.replace(
              /\n/g,
              "<br>"
            )}</p>`; // Display summary
          })
          .catch((error) => {
            console.error(
              `Failed to get overview for "${articleTitle}":`,
              error
            );
            modalSummaryEl.style.display = "none"; // Hide summary area on error
            modalErrorEl.textContent = `Error: ${error.message}`;
            modalErrorEl.style.display = "block";
          });
      }

      function closeModal() {
        modal.classList.remove("active");
        // Reset modal content for next time (optional, but good practice)
        modalTitleEl.textContent = "Article Title";
        modalSummaryEl.innerHTML =
          '<p class="loading-summary">Loading summary...</p>';
        modalErrorEl.textContent = "";
        modalErrorEl.style.display = "none";
      }

      async function handleOverviewClick(event) {
        const button = event.target;
        const url = button.dataset.url;
        const row = button.closest("tr");
        // Ensure title is fetched correctly from the link inside the <td>
        const articleTitleText =
          row.cells[2].querySelector("a")?.textContent.trim() || "Article";

        if (!url) {
          console.error("Missing URL for overview button.");
          return;
        }

        const apiKey = getApiKey();
        if (!apiKey) {
          modal.classList.add("active"); // Show modal to display API key error
          modalTitleEl.textContent = articleTitleText;
          modalSummaryEl.style.display = "none";
          modalErrorEl.textContent =
            "OpenAI API Key needed to generate summary.";
          modalErrorEl.style.display = "block";
          return;
        }

        button.disabled = true;
        const originalButtonText = button.textContent;
        button.textContent = "Loading...";

        const summaryPromise = (async () => {
          // This IIFE creates the promise that openModal will handle
          const articleText = await fetchArticleText(url);
          if (!articleText || articleText.length < 50) {
            throw new Error(
              "Could not extract sufficient article text for summary."
            );
          }
          return getOpenAISummary(articleText, apiKey);
        })();

        openModal(articleTitleText, summaryPromise);

        // Reset button once the process is handed off to the modal
        // Or, better, use the promise's finally to reset button after modal content is loaded/failed
        summaryPromise.finally(() => {
          button.disabled = false;
          button.textContent = originalButtonText;
        });
      }

      // Modal close event listeners
      modalCloseBtn.addEventListener("click", closeModal);
      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          // Clicked on the modal backdrop
          closeModal();
        }
      });
      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && modal.classList.contains("active")) {
          closeModal();
        }
      });

      /* ───────── UI HANDLERS ───────── */
      $("#fetchBtn").addEventListener("click", fetchNews);
      window.addEventListener("load", () => {
        updateApiKeyStatus(!!localStorage.getItem(OPENAI_API_KEY_STORAGE));
        fetchNews();
      });

      $("#saveApiKeyBtn").addEventListener("click", () => {
        const keyInput = $("#apiKeyInput");
        if (saveApiKey(keyInput.value)) {
          // keyInput.value = '';
        } else if (!keyInput.value.trim()) {
          $("#apiKeyStatus").textContent = "Please enter a key.";
          $("#apiKeyStatus").style.color = "var(--error)";
        } else {
          $("#apiKeyStatus").textContent = "Failed to save key (invalid?).";
          $("#apiKeyStatus").style.color = "var(--error)";
        }
      });
      $("#apiKeyInput").addEventListener("input", () => {
        if (!$("#apiKeyInput").value.trim()) {
          updateApiKeyStatus(!!localStorage.getItem(OPENAI_API_KEY_STORAGE));
        }
      });

      $("#news tbody").addEventListener("click", (event) => {
        if (event.target.classList.contains("overview-btn")) {
          handleOverviewClick(event);
        }
      });

      /* ───────── SEARCH FUNCTIONALITY ───────── */
      const searchInput = $("#searchInput");
      const clearSearchBtn = $("#clearSearch");
      const noResultsDiv = $("#noResults");

      searchInput.addEventListener("input", filterArticles);
      clearSearchBtn.addEventListener("click", clearSearch);

      function clearSearch() {
        searchInput.value = "";
        filterArticles();
        clearSearchBtn.style.display = "none";
      }

      function filterArticles() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const rows = $all("#news tbody tr");
        let matchCount = 0;

        clearSearchBtn.style.display = searchTerm ? "block" : "none";

        rows.forEach((row) => {
          const title = row.cells[2].textContent.toLowerCase();
          const source = row.cells[1].textContent.toLowerCase();
          const date = row.cells[0].textContent.toLowerCase();
          const isMatch =
            title.includes(searchTerm) ||
            source.includes(searchTerm) ||
            date.includes(searchTerm);
          row.classList.toggle("hidden", !isMatch);
          if (isMatch) matchCount++;
        });

        noResultsDiv.style.display =
          matchCount === 0 && rows.length > 0 && searchTerm ? "block" : "none";
        const tableShouldBeVisible =
          rows.length > 0 && (matchCount > 0 || !searchTerm);
        $("#news").style.display = tableShouldBeVisible ? "table" : "none";
        if (
          !tableShouldBeVisible &&
          !(matchCount === 0 && rows.length > 0 && searchTerm)
        ) {
          noResultsDiv.style.display = "none";
        }

        const status = $("#status");
        const absoluteTotal = $all("#news tbody tr").length;
        if (searchTerm) {
          status.textContent = `Found ${matchCount} matching articles (${absoluteTotal} total)`;
        } else {
          status.textContent = `Showing ${absoluteTotal} articles (updated ${dayjs().format(
            "HH:mm"
          )})`;
        }
      }

      async function fetchNews() {
        const btn = $("#fetchBtn"),
          statusEl = $("#status"),
          table = $("#news"),
          tbody = $("#news tbody"); // Renamed status to statusEl
        btn.disabled = true;
        statusEl.textContent = "Fetching…";
        tbody.innerHTML = "";
        table.hidden = true;
        noResultsDiv.style.display = "none";

        try {
          const results = await Promise.allSettled(
            SCRAPERS.map((fn) =>
              fn().catch((err) => {
                console.error(`Error in scraper ${fn.name}:`, err);
                return [];
              })
            )
          );

          const records = results
            .filter((result) => result.status === "fulfilled")
            .map((result) => result.value)
            .flat()
            .filter(Boolean)
            .sort((a, b) => b.article_date - a.article_date);

          tbody.innerHTML = "";
          if (records.length === 0) {
            statusEl.textContent = "No articles found or all scrapers failed.";
            noResultsDiv.textContent =
              "Could not fetch any articles. Check console for errors.";
            noResultsDiv.style.display = "block";
            table.hidden = true;
            return;
          }

          records.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${dayjs(r.article_date).format("YYYY‑MM‑DD")}</td>
        <td>${r.source}</td>
        <td><a href="${r.article_url}" target="_blank" rel="noopener">${
              r.article_title
            }</a></td>
        <td>
            <button class="overview-btn" data-url="${
              r.article_url
            }">AI Overview</button>
            <!-- Removed inline summary span -->
        </td>`;
            tbody.appendChild(tr);
          });

          table.hidden = false;
          statusEl.textContent = `Showing ${
            records.length
          } articles (updated ${dayjs().format("HH:mm")})`;
          clearSearch();
        } catch (err) {
          console.error("Error during fetchNews execution:", err);
          statusEl.textContent = "Error fetching data. Check console.";
          noResultsDiv.textContent = "An error occurred while fetching news.";
          noResultsDiv.style.display = "block";
          table.hidden = true;
        } finally {
          btn.disabled = false;
          filterArticles();
        }
      }

      /* ───────── TABLE SORTING ───────── */
      $all("th").forEach((th, headerIndex) => {
        if (headerIndex === 3) {
          th.style.cursor = "default";
          return;
        }
        th.onclick = () => {
          const tableBody = $("#news tbody");
          if (!tableBody) return;
          const currentRows = Array.from(tableBody.rows);
          const isAscending = th.textContent.includes("▲");
          const sortDirection = isAscending ? -1 : 1;
          currentRows.sort((rowA, rowB) => {
            const cellA = rowA.cells[headerIndex]?.innerText || "";
            const cellB = rowB.cells[headerIndex]?.innerText || "";
            if (headerIndex === 0) {
              const dateA = dayjs(cellA, "YYYY-MM-DD").toDate();
              const dateB = dayjs(cellB, "YYYY-MM-DD").toDate();
              if (dateA < dateB) return -1 * sortDirection;
              if (dateA > dateB) return 1 * sortDirection;
              return 0;
            } else {
              return cellA.localeCompare(cellB) * sortDirection;
            }
          });
          currentRows.forEach((row) => tableBody.appendChild(row));
          $all("th").forEach((header, idx) => {
            if (idx !== 3) {
              header.textContent = header.textContent
                .replace(/[▲▼]/, "")
                .trim();
            }
          });
          th.textContent += sortDirection === 1 ? " ▲" : " ▼";
          filterArticles();
        };
      });
    </script>
  </body>
</html>
