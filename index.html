<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Broadband‑News Dashboard</title>

<!-- date helper -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
<script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>


<style>
  :root{
    --bg:#f7f9fc;
    --card:#ffffff;
    --accent:#0057b7;
    --accent-light:#e9f1ff;
    --border:#d7e0ea;
    --text-light: #666;
    --text-dark: #111;
    --warn: #f9a825;
    --error: #d32f2f;
  }
  *{box-sizing:border-box;margin:0;padding:0;font:400 16px/1.4 system-ui,sans-serif}
  body{background:var(--bg);padding:2rem;display:flex;justify-content:center}
  main{width:100%;max-width:1000px}
  h1{font-size:1.9rem;margin-bottom:.8rem;color:var(--text-dark)}
  h1 small {font-size:1rem; color:var(--text-light)}

  #controls{display:flex;align-items:center;margin-bottom:1rem;gap:.75rem;flex-wrap:wrap}
  button{
    background:var(--accent);color:#fff;border:none;border-radius:8px;
    padding:.6rem 1.2rem;font-size:1rem;cursor:pointer;transition:.2s;
    line-height: 1.2; /* Added for consistency */
  }
  button:disabled{opacity:.55;cursor:progress}
  button:hover:not(:disabled){filter:brightness(1.08)}
  #status{font-size:.95rem;color:#444;margin-left:auto}

  /* Search bar styling */
  #searchWrapper {
    position: relative;
    display: flex;
    align-items: center;
    flex-grow: 1;
    max-width: 400px;
  }
  #searchInput {
    width: 100%;
    padding: .6rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: .2s;
  }
  #searchInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-light);
  }
  #clearSearch {
    position: absolute;
    right: 10px;
    background: none;
    border: none;
    color: #777;
    cursor: pointer;
    padding: 0;
    font-size: 1.2rem;
    display: none;
  }
  #clearSearch:hover {
    color: #333;
  }

  /* API Key Settings */
  #apiKeySettings {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--accent-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  #apiKeySettings label { font-weight: 500; }
  #apiKeyInput {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    flex-grow: 1;
    min-width: 200px;
  }
  #apiKeyInput:focus {
    outline: none;
    border-color: var(--accent);
  }
  #apiKeySettings button {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
    background-color: #4CAF50; /* Green for save */
  }
  #apiKeyStatus { color: var(--text-light); font-style: italic; }

  table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;
        box-shadow:0 2px 6px rgba(0,0,0,.06);background:var(--card)}
  thead{background:var(--accent-light)}
  th,td{padding:.75rem .9rem;text-align:left;border-bottom:1px solid var(--border)}
  th{font-weight:600;cursor:pointer;user-select:none}
  tr:hover td{background:#fafcff}
  tr.hidden{display:none}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  /* Overview button and summary styling */
  .overview-btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.85rem;
    background-color: #555;
    white-space: nowrap;
  }
  .overview-btn:disabled { background-color: #999; filter: none; }
  .summary-output {
    display: block; /* Changed from inline-block */
    margin-top: 0.5rem; /* Added margin */
    font-size: 0.85rem;
    color: var(--text-light);
    max-height: 100px; /* Limit initial height */
    overflow-y: auto; /* Allow scrolling for long summaries */
    background-color: #f0f0f0;
    padding: 0.4rem;
    border-radius: 4px;
    line-height: 1.3;
    border: 1px solid var(--border);
  }
  .summary-output.error { color: var(--error); }
  .summary-output.loading { font-style: italic; }

  #noResults {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
    background: var(--card);
    border-radius: 12px;
    display: none;
  }
  @media(max-width:768px){ /* Adjusted breakpoint */
     th:nth-child(3),td:nth-child(3){ /* Title */
         /* Keep title full width */
     }
     th:nth-child(4),td:nth-child(4){ /* Overview */
         /* Adjust overview layout */
     }
     th:nth-child(1),td:nth-child(1){width:90px} /* Date */
     th:nth-child(2),td:nth-child(2){width:110px} /* Source */

     .overview-btn { margin-bottom: 0.3rem; }
     .summary-output { max-width: 100%; } /* Ensure it doesn't overflow */
  }
  @media(max-width:600px){
    #controls { flex-direction: column; align-items: stretch; }
    #searchWrapper { max-width: 100%; margin-bottom: .5rem; }
    #status { margin-left: 0; text-align: center; margin-top: 0.5rem; }
    #apiKeySettings { flex-direction: column; align-items: stretch; }
    #apiKeyInput { min-width: unset; }
    /* Mobile table adjustments might be needed depending on content */
    th, td { padding: 0.5rem; font-size: 0.9rem;}
    th:nth-child(3), td:nth-child(3) { /* Title - less padding */ padding-right: 0.5rem;}
    th:nth-child(4), td:nth-child(4) { /* Overview */ padding-left: 0.5rem;}
    .summary-output { font-size: 0.8rem; max-height: 80px; }
  }
</style>
</head>
<body>
<main>
  <h1>Broadband‑Related Headlines <small> (last 90 days)</small></h1>

  <div id="controls">
    <button id="fetchBtn">Fetch latest news</button>

    <div id="searchWrapper">
      <input type="text" id="searchInput" placeholder="Search articles..." aria-label="Search articles">
      <button id="clearSearch" aria-label="Clear search">×</button>
    </div>

    <span id="status"></span>
  </div>

  <!-- API Key Section -->
  <div id="apiKeySettings">
      <label for="apiKeyInput">HF API Key:</label>
      <input type="password" id="apiKeyInput" placeholder="Paste your Hugging Face API Key (stored locally)">
      <button id="saveApiKeyBtn">Save Key</button>
      <span id="apiKeyStatus"></span>
  </div>

  <div id="noResults">No matching articles found</div>

  <table id="news" hidden>
    <thead><tr>
      <th data-key="article_date">Date ▼</th>
      <th data-key="source">Source</th>
      <th data-key="article_title">Title</th>
      <th>Overview</th> <!-- New Column -->
    </tr></thead>
    <tbody><!-- Content added by JS --></tbody>
  </table>
</main>

<script>
/* ───────── CONFIG ───────── */
const CORS_PROXY = "https://api.allorigins.win/raw?url="; // NOTE: This free proxy has limitations
const N_ARTICLES = 10; // Per source
const CUTOFF = dayjs().subtract(90,"day").toDate();
const HF_API_KEY_STORAGE = "hfApiKey";
const HF_SUMMARIZATION_MODEL = "facebook/bart-large-cnn"; // You can change this model if needed
const HF_API_URL = `https://api-inference.huggingface.co/models/${HF_SUMMARIZATION_MODEL}`;

/* ───────── HELPERS ───────── */
const $ = (sel, root=document) => root.querySelector(sel);
const $all = (sel, root=document) => [...root.querySelectorAll(sel)];
function parseHTML(html){return new DOMParser().parseFromString(html,"text/html");}
async function fetchDoc(url, options = {}){ // Added options for potential future use
  try {
    const response = await fetch(CORS_PROXY+encodeURIComponent(url), options);
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    const text = await response.text();
    // Handle potential allorigins error messages embedded in the response
    if (text.includes("allorigins error") || text.includes("target server error")) {
        console.warn(`CORS Proxy error for ${url}: ${text.substring(0, 100)}...`);
        throw new Error("CORS Proxy error fetching content.");
    }
    return parseHTML(text);
  } catch (error) {
      console.error(`Error fetching document ${url}:`, error);
      throw error; // Re-throw to be caught by caller
  }
}
function keepDate(d){return d && d >= CUTOFF;}
function tryParse(raw,...fmts){
  raw=(raw||"").trim();
  for(const f of fmts){
    const d=dayjs(raw,f,true);
    if(d.isValid())return d.toDate();
  }
  return null;
}

/* ───────── API Key Management ───────── */
function getApiKey() {
    let key = localStorage.getItem(HF_API_KEY_STORAGE);
    if (!key) {
        key = prompt("Please enter your Hugging Face API Key for summarization.\nIt will be stored locally in your browser.");
        if (key) {
            saveApiKey(key);
        } else {
            return null; // User cancelled
        }
    }
    return key;
}

function saveApiKey(key) {
    if (key && typeof key === 'string' && key.trim()) {
        localStorage.setItem(HF_API_KEY_STORAGE, key.trim());
        updateApiKeyStatus(true); // Indicate saved
        $("#apiKeyInput").value = key.trim(); // Update input field as well
        return true;
    }
    updateApiKeyStatus(false); // Indicate not saved/invalid
    return false;
}

function updateApiKeyStatus(isSet) {
    const statusEl = $("#apiKeyStatus");
    if (isSet) {
        statusEl.textContent = "Key saved locally.";
        statusEl.style.color = "green";
    } else {
        const currentKey = localStorage.getItem(HF_API_KEY_STORAGE);
        statusEl.textContent = currentKey ? "Key saved locally." : "Key not set.";
         statusEl.style.color = currentKey ? "green" : "var(--text-light)";
    }
}


/* ───────── 12 SCRAPERS (Unchanged - Preserving Original Logic) ───────── */
async function scrape_ntia(){
  const doc=await fetchDoc("https://broadbandusa.ntia.gov/news/latest-news");
  return $all("div.views-row",doc).slice(0,N_ARTICLES).map(row=>{
    const t=$("span.field-content a",row);
    const d=tryParse($("div.views-field-created span.field-content",row)?.textContent,"MMMM D, YYYY");
    if(!t||!keepDate(d))return null;
    return{source:"NTIA",article_title:t.textContent.trim(),
      article_url:"https://broadbandusa.ntia.gov"+t.href,article_date:d};
  }).filter(Boolean);
}
async function scrape_theverge(){
  const doc=await fetchDoc("https://www.theverge.com/");
  return $all("article",doc).slice(0,N_ARTICLES).map(c=>{
    const a=$("a[data-analytics-link]",c);
    const d=tryParse($("time",c)?.dateTime,"YYYY-MM-DD");
    if(!a||!keepDate(d))return null;
    let link=a.href; if(!/^https?:/.test(link))link="https://www.theverge.com"+link;
    return{source:"The Verge",article_title:a.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_telecompetitor(){
  const doc=await fetchDoc("https://www.telecompetitor.com/articles/");
  return $all("article",doc).slice(0,N_ARTICLES).map(b=>{
    const a=$("h2.wp-block-post-title a",b);
    const d=tryParse($("time",b)?.textContent,"MMMM D, YYYY");
    if(!a||!keepDate(d))return null;
    return{source:"Telecompetitor",article_title:a.textContent.trim(),article_url:a.href,article_date:d};
  }).filter(Boolean);
}
async function scrape_networkworld(){
  const doc=await fetchDoc("https://www.networkworld.com/news/");
  return $all("div.card",doc).slice(0,N_ARTICLES).map(c=>{
    const h3=$("h3.card__title",c), a=$("a",c);
    const d=tryParse($("time",c)?.dateTime,"YYYY-MM-DD");
    if(!h3||!a||!keepDate(d))return null;
    let link=a.href; if(!/^https?:/.test(link))link="https://www.networkworld.com"+link;
    return{source:"Network World",article_title:h3.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_lightreading(){
  const doc=await fetchDoc("https://www.lightreading.com");
  return $all("div.ArticlePreview",doc).slice(0,N_ARTICLES).map(dv=>{
    const title=$("div.ArticlePreview__Title",dv);
    const d=tryParse($("span.ArticlePreview__Date",dv)?.textContent,"MMM D, YYYY");
    let link=$("a",dv)?.href||""; if(link.startsWith("/"))link="https://www.lightreading.com"+link;
    if(!title||!keepDate(d))return null;
    return{source:"Light Reading",article_title:title.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_broadbandnow(){
  const doc=await fetchDoc("https://broadbandnow.com/research");
  return $all("div.card.research",doc).slice(0,N_ARTICLES).map(c=>{
    const a=$("h2.card-title",c), link=$("a.thumbnail",c);
    const d=tryParse($("p.card-updated-date",c)?.textContent,"MMMM D, YYYY");
    if(!a||!link||!keepDate(d))return null;
    return{source:"BroadbandNow",article_title:a.textContent.trim(),article_url:link.href,article_date:d};
  }).filter(Boolean);
}
async function scrape_rcrwireless(){
  const doc=await fetchDoc("https://www.rcrwireless.com/");
  return $all("div.td-module-thumb",doc).slice(0,N_ARTICLES).map(b=>{
    const par=b.parentElement;
    const title=$("h3.entry-title a",par);
    const d=tryParse($("time.entry-date",par)?.dateTime,"YYYY-MM-DD");
    const author=$("span.td-post-author-name",par);
    const excerpt=$("div.td-excerpt",par);
    if(!title||!keepDate(d))return null;
    return{source:"RCR Wireless",article_title:title.textContent.trim(),article_url:title.href,
      article_date:d,author:author?.textContent.trim()||null,excerpt:excerpt?.textContent.trim()||null};
  }).filter(Boolean);
}
async function scrape_lightwave(){
  const doc=await fetchDoc("https://www.lightwaveonline.com/broadband");
  return $all("a.title-wrapper",doc).slice(0,N_ARTICLES).map(a=>{
    const d=tryParse(a.closest("div")?.querySelector("div.date")?.textContent,"MMM D, YYYY");
    let link=a.href; if(link.startsWith("/"))link="https://www.lightwaveonline.com"+link;
    if(!keepDate(d))return null;
    return{source:"Lightwave Online",article_title:a.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_advanced_tv(){
  const doc=await fetchDoc("https://www.advanced-television.com/?s=broadband");
  return $all("article.text-secondary",doc).slice(0,N_ARTICLES).map(art=>{
    const a=$("a.text-dark",art);
    const d=tryParse($("div.border span",art)?.textContent,"MMMM D, YYYY");
    let link=a?.href||""; if(link.startsWith("/"))link="https://www.advanced-television.com"+link;
    if(!a||!keepDate(d))return null;
    return{source:"Advanced TV",article_title:a.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_cnet(){
  const doc=await fetchDoc("https://www.cnet.com/search/?searchQuery=broadband");
  return $all("article.c-pageSearch_searchResult",doc).slice(0,N_ARTICLES).map(art=>{
    const a=$("a.c-pageSearch_searchResultUrlContainer",art);
    const d=tryParse($("time",art)?.dateTime,"YYYY-MM-DD");
    let link=a?.href||""; if(link.startsWith("/"))link="https://www.cnet.com"+link;
    if(!a||!keepDate(d))return null;
    return{source:"CNET",article_title:a.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_fiberoptics(){
  const doc=await fetchDoc("https://www.fiberopticsonline.com/hub/bucket/homelatestheadlines");
  return $all("li.mb-2.vm-summary-link",doc).slice(0,N_ARTICLES).map(li=>{
    const a=li.querySelector("a");
    const d=tryParse(li.querySelector("em.vm-hub-date")?.textContent,"MMM D, YYYY");
    let link=a?.href||""; if(link.startsWith("/"))link="https://www.fiberopticsonline.com"+link;
    if(!a||!keepDate(d))return null;
    return{source:"Fiber Optics Online",article_title:a.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}
async function scrape_techradar(){
  const doc=await fetchDoc("https://www.techradar.com/search?searchTerm=broadband");
  return $all("article.search-result",doc).slice(0,N_ARTICLES).map(art=>{
    const h3=$("h3.article-name",art), a=$("a.article-link",art);
    const d=tryParse($("time.no-wrap.relative-date.date-with-prefix",art)?.dateTime,"YYYY-MM-DD");
    let link=a?.href||""; if(link.startsWith("/"))link="https://www.techradar.com"+link;
    if(!h3||!keepDate(d))return null;
    return{source:"TechRadar",article_title:h3.textContent.trim(),article_url:link,article_date:d};
  }).filter(Boolean);
}

const SCRAPERS=[
  scrape_ntia,scrape_theverge,scrape_telecompetitor,scrape_networkworld,
  scrape_lightreading,scrape_broadbandnow,scrape_rcrwireless,scrape_lightwave,
  scrape_advanced_tv,scrape_cnet,scrape_fiberoptics,scrape_techradar
];


/* ───────── AI Summarization ───────── */

// Basic content extraction - VERY LIKELY TO NEED ADJUSTMENT PER SITE
function extractMainContent(doc) {
    const selectors = [
        'article',
        'main',
        '.main-content',
        '.post-content',
        '.entry-content',
        '.article-body',
        '.story-content',
        'div[role="main"]'
    ];
    let mainEl = null;
    for (const selector of selectors) {
        mainEl = doc.querySelector(selector);
        if (mainEl) break;
    }
    if (!mainEl) mainEl = doc.body; // Fallback to body

    // Get all paragraphs within the main element
    const paragraphs = $all('p', mainEl);
    let text = paragraphs.map(p => p.textContent.trim()).join('\n');

    // Basic cleanup
    text = text.replace(/\s{2,}/g, ' '); // Replace multiple spaces/newlines with single space
    text = text.trim();

    // Limit length to avoid overly long inputs for the API (e.g., ~10k chars)
    const MAX_LENGTH = 10000;
    if (text.length > MAX_LENGTH) {
        console.warn("Extracted text truncated for API call.");
        text = text.substring(0, MAX_LENGTH) + "...";
    }

    if (text.length < 100) { // Arbitrary minimum length
        console.warn("Extracted text seems very short, might be inaccurate.");
    }

    return text;
}

async function fetchArticleText(url) {
    console.log(`Fetching article content for: ${url}`);
    const doc = await fetchDoc(url); // Uses the existing helper with CORS proxy
    return extractMainContent(doc);
}

async function getHuggingFaceSummary(text, apiKey) {
    if (!text) {
        throw new Error("No text content provided for summarization.");
    }
    console.log(`Requesting summary from HF for ${text.length} chars...`);

    try {
        const response = await fetch(HF_API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                inputs: text,
                parameters: { // Optional: Adjust summary length
                    min_length: 30,
                    max_length: 150
                }
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown API error' }));
             let errorMessage = `HF API Error: ${response.status}`;
             if (errorData.error) {
                 errorMessage += ` - ${errorData.error}`;
             }
             // Specific check for model loading
             if (errorData.error && errorData.error.includes("currently loading")) {
                 errorMessage = "Model is loading, try again shortly.";
             }
             console.error("HF API Error Response:", errorData);
             throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log("HF API Success:", result);

        // The result format might be [{ summary_text: "..." }]
        if (Array.isArray(result) && result.length > 0 && result[0].summary_text) {
            return result[0].summary_text;
        } else if (result.summary_text) { // Or just { summary_text: "..." }
             return result.summary_text;
        } else {
            console.error("Unexpected HF API response format:", result);
            throw new Error("Could not parse summary from API response.");
        }
    } catch (error) {
        console.error('Error fetching summary from Hugging Face:', error);
        throw error; // Re-throw to be handled by the click handler
    }
}

async function handleOverviewClick(event) {
    const button = event.target;
    const outputSpan = button.nextElementSibling; // Assumes span is immediately after
    const url = button.dataset.url;

    if (!url || !outputSpan) {
        console.error("Missing URL or output span for overview button.");
        return;
    }

    const apiKey = getApiKey();
    if (!apiKey) {
        outputSpan.textContent = "API Key needed.";
        outputSpan.className = 'summary-output error';
        return;
    }

    button.disabled = true;
    button.textContent = "Loading...";
    outputSpan.textContent = "Fetching article content...";
    outputSpan.className = 'summary-output loading';
    outputSpan.style.display = 'block'; // Ensure it's visible

    try {
        const articleText = await fetchArticleText(url);
        if (!articleText || articleText.length < 50) { // Check for minimal content
             throw new Error("Could not extract sufficient article text.");
        }

        outputSpan.textContent = "Generating summary...";
        const summary = await getHuggingFaceSummary(articleText, apiKey);

        outputSpan.textContent = summary;
        outputSpan.className = 'summary-output';
        button.textContent = "Overview"; // Reset button text

    } catch (error) {
        console.error(`Failed to get overview for ${url}:`, error);
        outputSpan.textContent = `Error: ${error.message}`;
        outputSpan.className = 'summary-output error';
        button.textContent = "Retry"; // Allow retry
    } finally {
        button.disabled = false;
    }
}


/* ───────── UI HANDLERS ───────── */
$("#fetchBtn").addEventListener("click", fetchNews);
window.addEventListener("load", () => {
    // Set initial API Key status message and load news
    updateApiKeyStatus(!!localStorage.getItem(HF_API_KEY_STORAGE));
    fetchNews();
});

// API Key Save Button
$("#saveApiKeyBtn").addEventListener("click", () => {
    const keyInput = $("#apiKeyInput");
    if (saveApiKey(keyInput.value)) {
        // Optionally clear the input after save, or keep it visible
        // keyInput.value = '';
    } else if (!keyInput.value.trim()) {
         $("#apiKeyStatus").textContent = "Please enter a key.";
         $("#apiKeyStatus").style.color = "var(--error)";
    } else {
        $("#apiKeyStatus").textContent = "Failed to save key (invalid?).";
        $("#apiKeyStatus").style.color = "var(--error)";
    }
});
// Update status if user manually clears input
$("#apiKeyInput").addEventListener("input", () => {
    if (!$("#apiKeyInput").value.trim()) {
        updateApiKeyStatus(!!localStorage.getItem(HF_API_KEY_STORAGE)); // Reset to saved status or 'not set'
    }
});

// Event delegation for overview buttons
$("#news tbody").addEventListener("click", (event) => {
    if (event.target.classList.contains("overview-btn")) {
        handleOverviewClick(event);
    }
});


/* ───────── SEARCH FUNCTIONALITY ───────── */
const searchInput = $("#searchInput");
const clearSearchBtn = $("#clearSearch");
const noResultsDiv = $("#noResults");

searchInput.addEventListener("input", filterArticles);
clearSearchBtn.addEventListener("click", clearSearch);

function clearSearch() {
  searchInput.value = "";
  filterArticles();
  clearSearchBtn.style.display = "none";
}

function filterArticles() {
  const searchTerm = searchInput.value.toLowerCase().trim();
  const rows = $all("#news tbody tr");
  let matchCount = 0;

  // Show/hide clear button
  clearSearchBtn.style.display = searchTerm ? "block" : "none";

  rows.forEach(row => {
    const title = row.cells[2].textContent.toLowerCase();
    const source = row.cells[1].textContent.toLowerCase();
    const date = row.cells[0].textContent.toLowerCase();

    // Match title, source, or date
    const isMatch = title.includes(searchTerm) ||
                   source.includes(searchTerm) ||
                   date.includes(searchTerm);

    row.classList.toggle("hidden", !isMatch);
    if (isMatch) matchCount++;
  });

  // Show/hide no results message
  noResultsDiv.style.display = matchCount === 0 && rows.length > 0 && searchTerm ? "block" : "none"; // Only show if rows exist but none match search

  // Show/hide table based on search results and total rows
  const tableShouldBeVisible = rows.length > 0 && (matchCount > 0 || !searchTerm);
  $("#news").style.display = tableShouldBeVisible ? "table" : "none";
  if (!tableShouldBeVisible && !(matchCount === 0 && rows.length > 0 && searchTerm)) { // Hide noResults if table itself is hidden for other reasons
      noResultsDiv.style.display = "none";
  }


  // Update status message
  const status = $("#status");
  const totalRows = $all("#news tbody tr:not(.hidden)").length; // Count only visible rows after filtering
  const absoluteTotal = $all("#news tbody tr").length; // Get total fetched before filtering
  if (searchTerm) {
    status.textContent = `Found ${matchCount} matching articles (${absoluteTotal} total)`;
  } else {
      status.textContent = `Showing ${absoluteTotal} articles (updated ${dayjs().format("HH:mm")})`;
  }
}

async function fetchNews(){
  const btn=$("#fetchBtn"),status=$("#status"),table=$("#news"),tbody=$("#news tbody");
  btn.disabled=true; status.textContent="Fetching…";
  tbody.innerHTML = ""; // Clear previous results
  table.hidden = true; // Hide table while fetching
  noResultsDiv.style.display = "none"; // Hide no results message

  try{
    // Wrap scraper calls in error handling
    const results = await Promise.allSettled(SCRAPERS.map(fn => fn().catch(err => {
        // Catch errors within individual scrapers
        console.error(`Error in scraper ${fn.name}:`, err);
        return []; // Return empty array on error for this source
    })));

    const records = results
        .filter(result => result.status === 'fulfilled') // Keep only successful scrapes
        .map(result => result.value) // Get the array of articles
        .flat() // Flatten the array of arrays
        .filter(Boolean) // Ensure no null/undefined items remain
        .sort((a,b)=>b.article_date-a.article_date); // Sort by date descending

    tbody.innerHTML=""; // Clear again just in case
    if (records.length === 0) {
        status.textContent = "No articles found or all scrapers failed.";
        noResultsDiv.textContent = "Could not fetch any articles. Check console for errors.";
        noResultsDiv.style.display = "block";
        table.hidden = true;
        return; // Stop if no records
    }

    records.forEach(r=>{
      const tr=document.createElement("tr");
      // Added data-url to the button and a span for output
      tr.innerHTML=`
        <td>${dayjs(r.article_date).format("YYYY‑MM‑DD")}</td>
        <td>${r.source}</td>
        <td><a href="${r.article_url}" target="_blank" rel="noopener">${r.article_title}</a></td>
        <td>
            <button class="overview-btn" data-url="${r.article_url}">Overview</button>
            <span class="summary-output" style="display: none;"></span>
        </td>`;
      tbody.appendChild(tr);
    });

    table.hidden=false;
    status.textContent=`Showing ${records.length} articles (updated ${dayjs().format("HH:mm")})`;

    // Clear search field and reset filtering
    clearSearch();
  }catch(err){ // Catch errors from Promise.allSettled or sorting/rendering
    console.error("Error during fetchNews execution:", err);
    status.textContent="Error fetching data. Check console.";
    noResultsDiv.textContent = "An error occurred while fetching news.";
    noResultsDiv.style.display = "block";
    table.hidden = true;
  }finally{
    btn.disabled=false;
    // Ensure filter state is correct even after errors
    filterArticles();
  }
}

/* ───────── TABLE SORTING ───────── */
$all("th").forEach((th, headerIndex) => {
    // Disable sorting for the new 'Overview' column
    if (headerIndex === 3) { // 0: Date, 1: Source, 2: Title, 3: Overview
        th.style.cursor = 'default';
        return;
    }

    th.onclick = () => {
        const tableBody = $("#news tbody");
        if (!tableBody) return; // Ensure tbody exists

        const currentRows = Array.from(tableBody.rows);
        const isAscending = th.textContent.includes("▲");
        const sortDirection = isAscending ? -1 : 1; // Toggle direction

        currentRows.sort((rowA, rowB) => {
            const cellA = rowA.cells[headerIndex]?.innerText || '';
            const cellB = rowB.cells[headerIndex]?.innerText || '';

            // Date sort (index 0)
            if (headerIndex === 0) {
                // Use Date objects for reliable comparison
                const dateA = dayjs(cellA, "YYYY-MM-DD").toDate();
                const dateB = dayjs(cellB, "YYYY-MM-DD").toDate();
                if (dateA < dateB) return -1 * sortDirection;
                if (dateA > dateB) return 1 * sortDirection;
                return 0;
            } else {
                // Default string sort for Source (1) and Title (2)
                return cellA.localeCompare(cellB) * sortDirection;
            }
        });

        // Re-append sorted rows
        currentRows.forEach(row => tableBody.appendChild(row));

        // Update header arrows
        $all("th").forEach((header, idx) => {
            // Skip the Overview header
             if (idx !== 3) {
                 header.textContent = header.textContent.replace(/[▲▼]/, "").trim();
             }
        });
         th.textContent += (sortDirection === 1 ? " ▲" : " ▼");


        // Re-apply search filter after sorting (important!)
        filterArticles();
    };
});

</script>
</body>
</html>